export project_dir=/home/ubuntu/malware-analysis/malware_classificator/data-prep
cd $project_dir

source env/bin/activate

python3 scripts/download_s3_files.py dionaea-files-023981 data/s3_data
echo "------------------------------------------"
ls ./data/s3_data
echo "------------------------------------------"
# Iterate over each file in the directory
for FILE in "./data/s3_data"/*; do
    if [ -f "$FILE" ]; then
	FILENAME=$(basename "$FILE")
	UNFORMATTED_FILE="./data/unformatted_data/analysis_${FILENAME}.json"
        echo "Processing $FILE"
        # Execute the script with the file as an argument
	cd processing_files
        "./malware-analysis.sh" ../"$FILE"
	cd ..
	echo $UNFORMATTED_FILE
	python3 scripts/json_format.py $UNFORMATTED_FILE ./data/formatted_data/
	rm -f "$FILE"
	rm -f ./data/unformatted_data/*	
	cd models
	OUTPUT=$(python3 classify.py random_forest_model.joblib ../data/formatted_data/analysis_${FILENAME}.json | tail -n 1)
	cd ..
	if [[ "$OUTPUT" != 0 && "$OUTPUT" != 1 ]]; then
	    echo "[ERROR] problems occured during classification"
	    aws s3api put-object-tagging \
    	      --bucket dionaea-files-023981 \
    	      --key ${FILENAME} \
    	      --tagging "TagSet=[{Key=file-category,Value=ERROR}}]"
	else
	    echo "Finish $FILENAME processing with ${OUTPUT} value"
	    aws s3api put-object-tagging \
    	      --bucket dionaea-files-023981 \
    	      --key ${FILENAME} \
    	      --tagging "TagSet=[{Key=file-category,Value=${OUTPUT}}]"
	fi
    fi
done
