import json
from collections import defaultdict

# Load the Capa JSON file
with open("./tmp/tmp_capa_features.json", "r") as file:
    capa_data = json.load(file)

# Extract ATT&CK Tactics and Techniques
attack_dict = defaultdict(list)
for rule_name, rule_data in capa_data["rules"].items():
    for attack in rule_data["meta"].get("att&ck", []):
        tactic, technique = attack.split("::")
        attack_dict[tactic].append(technique)

# Extract Capabilities and Namespaces
capabilities_list = []
for rule_name, rule_data in capa_data["rules"].items():
    namespace = rule_data["meta"].get("namespace", "unknown")
    match_count = len(rule_data["matches"])
    capabilities_list.append(
        {"capability": rule_name, "namespace": namespace, "matches": match_count}
    )

# Extract specific Meta Information
meta_info = capa_data.get("meta", {})
sample_info = meta_info.get("sample", {})
extracted_meta = {
    "path": sample_info.get("path"),
    "md5": sample_info.get("md5"),
    "sha1": sample_info.get("sha1"),
    "sha256": sample_info.get("sha256"),
    "os": meta_info.get("analysis", {})["os"],
}

# Prepare data to be saved in JSON
output_data = {
    "meta": extracted_meta,
    "attack_tactics_techniques": attack_dict,
    "capabilities": capabilities_list,
}

# Save to JSON file
with open("./tmp/tmp_extracted_capa_features.json", "w") as outfile:
    json.dump(output_data, outfile, indent=4)

